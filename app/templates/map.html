{% extends 'base.html' %}

{% block content %}
{% include 'sidebar.html' %}

<div class="main-content">
    <div id="map"></div>
    
    <!-- Overlay Elements -->
    <div class="map-overlays">
        <!-- Title Overlay -->
        <div class="title-overlay">
            <h1 class="dashboard-title">Fleet Command Center</h1>
            <div class="dashboard-subtitle">Real-Time Monitoring System</div>
        </div>

        <!-- Stats Overlay -->
        <div class="stats-overlay">
            <div class="stat-item">
                <div class="stat-icon">
                    <i class="fas fa-satellite"></i>
                </div>
                <div class="stat-info">
                    <div class="stat-value">98.7%</div>
                    <div class="stat-label">System Uptime</div>
                </div>
            </div>
            <div class="stat-item">
                <div class="stat-icon">
                    <i class="fas fa-signal"></i>
                </div>
                <div class="stat-info">
                    <div class="stat-value">124/125</div>
                    <div class="stat-label">Connected Units</div>
                </div>
            </div>
            <div class="stat-item">
                <div class="stat-icon">
                    <i class="fas fa-clock"></i>
                </div>
                <div class="stat-info">
                    <div class="stat-value">Live</div>
                    <div class="stat-label">Last Update: 2s ago</div>
                </div>
            </div>
        </div>

        <!-- Scenario Controls Overlay -->
        <div class="controls-overlay">
            <div class="scenario-controls">
                <select id="scenarioSelect" class="scenario-select">
                    <option value="">Select a scenario...</option>
                </select>
                <button class="run-scenario">
                    <i class="fas fa-play"></i>
                    Run Scenario
                </button>
            </div>
        </div>
    </div>
</div>


<!-- SIMULATION COMPLETED POPUP -->
<div id="simulationEndDialog" class="modal" style="display: none;">
    <div class="modal-content">
        <div class="modal-icon">
            <i class="fas fa-moon"></i>
        </div>
        <h2>End of Day</h2>
        <p>All fleet operations have been completed for today. Your vehicles have served the city well!</p>
        <button onclick="closeSimulationEndDialog()" class="modal-close-btn">
            <i class="fas fa-check"></i> Close
        </button>
    </div>
</div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.js"></script>
<style>
    .custom-marker i {
        font-size: 14px;
        color: white;
    }
    .legend {
        background: rgba(255, 255, 255, 0.95);
        padding: 15px;
        border-radius: 10px;
        box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
        font-family: 'Inter', sans-serif;
        border: 1px solid rgba(0, 0, 0, 0.05);
    }
    .legend h4 {
        font-weight: 500;
        font-size: 14px;
        margin-bottom: 12px;
        color: #1a1a1a;
    }
    .legend-item {
        display: flex;
        align-items: center;
        margin: 8px 0;
        font-size: 12px;
        color: #4a5568;
    }
    .legend i {
        margin-right: 8px;
        width: 20px;
        text-align: center;
    }

    :root {
    }
    
    #map {
        width: 100% !important;
        height: 100vh !important;
    }

    .custom-marker {
        transition: all 0.3s ease;
    }
    .modal {
        display: none;
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background-color: rgba(0, 0, 0, 0.5);
        z-index: 1000;
        display: flex;
        align-items: center;
        justify-content: center;
    }
    
    .modal-content {
        background-color: white;
        padding: 30px;
        border-radius: 10px;
        box-shadow: 0 4px 20px rgba(0, 0, 0, 0.2);
        text-align: center;
        max-width: 400px;
        animation: modalFadeIn 0.3s ease-out;
    }
    
    @keyframes modalFadeIn {
        from {
            opacity: 0;
            transform: scale(0.95);
        }
        to {
            opacity: 1;
            transform: scale(1);
        }
    }
    
    .modal-icon {
        font-size: 40px;
        color: #4a90e2;
        margin-bottom: 20px;
    }
    
    .modal-content h2 {
        color: #333;
        margin-bottom: 15px;
        font-size: 24px;
    }
    
    .modal-content p {
        color: #666;
        margin-bottom: 25px;
        line-height: 1.5;
    }
    
    .modal-close-btn {
        background-color: #4a90e2;
        color: white;
        border: none;
        padding: 10px 20px;
        border-radius: 5px;
        cursor: pointer;
        font-size: 14px;
        transition: background-color 0.2s;
    }
    
    .modal-close-btn:hover {
        background-color: #357abd;
    }
</style>

<script>
// Constants
const MUNICH_CENTER = [48.137154, 11.576124]; // [lat, lng]
const MUNICH_BOUNDS = {
    lat: { min: 48.0, max: 48.25 },
    lng: { min: 11.36, max: 11.79 }
};

const MAX_BOUNDS = [
    [MUNICH_BOUNDS.lat.min, MUNICH_BOUNDS.lng.min],
    [MUNICH_BOUNDS.lat.max, MUNICH_BOUNDS.lng.max]
];

// Initialize map
const map = L.map('map', {
    center: MUNICH_CENTER,
    zoom: 12,
    maxBounds: MAX_BOUNDS,
    minZoom: 11,
    zoomControl: false,
    attributionControl: false
});

// Add map tiles
L.tileLayer('https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}{r}.png', {
}).addTo(map);

// Add zoom control
L.control.zoom({
    position: 'bottomright'
}).addTo(map);

// Global variables
let currentScenarioId = null;
let simulationRunning = false;
let updateInterval;
let lastUpdateTime = Date.now();
let currentMarkers = new Map();
let currentLines = new Map();

function updateLastUpdateTime() {
    const timeDiff = Math.round((Date.now() - lastUpdateTime) / 1000);
    const timeElement = document.querySelector('.stats-overlay .stat-item:last-child .stat-value');
    if (timeElement) {
        timeElement.textContent = timeDiff < 60 ? `${timeDiff}s ago` : 'Live';
    }
}

function showSimulationEndDialog() {
    document.getElementById('simulationEndDialog').style.display ='flex';
    simulationRunning = false;
    currentScenarioId = null; 
    updateUI(false);
    stopUpdates();
}

function closeSimulationEndDialog() {
    document.getElementById('simulationEndDialog').style.display = 'none';
}

function getPosition(coordX, coordY) { //smazat
    // Handle null or undefined coordinates
    if (coordX == null || coordY == null) {
        console.warn('Null coordinates received:', { coordX, coordY });
        return MUNICH_CENTER; // Return default position
    }

    const lat = Number(coordX);
    const lng = Number(coordY);

    // Check if coordinates are valid numbers
    if (isNaN(lat) || isNaN(lng)) {
        console.warn('Invalid coordinates received:', { coordX, coordY });
        return MUNICH_CENTER;
    }

    // Ensure coordinates stay within bounds
    const boundedLat = Math.max(MUNICH_BOUNDS.lat.min, Math.min(MUNICH_BOUNDS.lat.max, lat));
    const boundedLng = Math.max(MUNICH_BOUNDS.lng.min, Math.min(MUNICH_BOUNDS.lng.max, lng));

    return [boundedLat, boundedLng];
}

function updateMap(data) {
    console.log('Updating map with new data:', data);

    if (!data?.vehicles || !data?.customers) {
        console.error('Invalid data structure:', data);
        return;
    }

    // Update customers
    data.customers.forEach(customer => {
        const markerId = `customer-${customer.id}`;
        const lineId = `line-${customer.id}`;

        if (customer.awaitingService) {
            const [lat, lng] = getPosition(customer.coordX, customer.coordY);
            const [destLat, destLng] = getPosition(customer.destinationX, customer.destinationY);
            console.log(`Customer ${customer.id} position:`, [lat, lng]);

            // Handle the line and destination marker
            if (!currentLines.has(lineId)) {
                // Create new line
                const polyline = L.polyline(
                    [[lat, lng], [destLat, destLng]],
                    {
                        color: '#FF5722',
                        weight: 2,
                        opacity: 0.6,
                        dashArray: '5, 10'
                    }
                ).addTo(map);

                // Create destination marker
                const destinationMarker = L.marker([destLat, destLng], {
                    icon: L.divIcon({
                        html: `<div style="
                            background-color: #FF5722;
                            width: 20px;
                            height: 20px;
                            border-radius: 50%;
                            display: flex;
                            align-items: center;
                            justify-content: center;
                            box-shadow: 0 0 10px rgba(0,0,0,0.2);
                        "><i class="fas fa-flag" style="font-size: 10px; color: white;"></i></div>`,
                        className: 'custom-marker'
                    })
                }).addTo(map);

                destinationMarker.bindPopup(`
                    <div style="font-family: 'Inter', sans-serif; font-size: 12px;">
                        <strong style="color: #1a1a1a;">Destination</strong><br>
                        <span style="color: #666;">Customer ${customer.id}</span>
                    </div>
                `);

                currentLines.set(lineId, {
                    line: polyline,
                    marker: destinationMarker
                });
            } else {
                // Update existing line and marker positions
                const lineObjects = currentLines.get(lineId);
                lineObjects.line.setLatLngs([[lat, lng], [destLat, destLng]]);
                lineObjects.marker.setLatLng([destLat, destLng]);
            }

            // Handle the customer marker
            if (!currentMarkers.has(markerId)) {
                const customerMarker = L.marker([lat, lng], {
                    icon: L.divIcon({
                        html: `<div style="
                            background-color: #FFC107;
                            width: 30px;
                            height: 30px;
                            border-radius: 50%;
                            display: flex;
                            align-items: center;
                            justify-content: center;
                            box-shadow: 0 0 15px rgba(0,0,0,0.2);
                        "><i class="fas fa-user"></i></div>`,
                        className: 'custom-marker'
                    })
                }).addTo(map);

                customerMarker.bindPopup(`
                    <div style="font-family: 'Inter', sans-serif; font-size: 12px;">
                        <strong style="color: #1a1a1a;">Customer ${customer.id}</strong><br>
                        <span style="color: #FFC107;">Waiting for pickup</span><br>
                        <span style="color: #666;">Position: [${lat.toFixed(6)}, ${lng.toFixed(6)}]</span>
                    </div>
                `);

                currentMarkers.set(markerId, customerMarker);
            } else {
                currentMarkers.get(markerId).setLatLng([lat, lng]);
            }
        } else {
            // Remove customer marker if not awaiting service
            if (currentMarkers.has(markerId)) {
                map.removeLayer(currentMarkers.get(markerId));
                currentMarkers.delete(markerId);
            }
            
            // Remove line and destination marker
            if (currentLines.has(lineId)) {
                const lineObjects = currentLines.get(lineId);
                map.removeLayer(lineObjects.line);
                map.removeLayer(lineObjects.marker);
                currentLines.delete(lineId);
            }
        }
    });

    const busyVehicleIds = new Set();
    data.vehicles.forEach(vehicle => {
        data.customers.forEach(customer => {
            if (!customer.awaitingService && // customer is not waiting (being transported)
                vehicle.coordX === customer.coordX && 
                vehicle.coordY === customer.coordY) {
                busyVehicleIds.add(vehicle.id);
            }
        });
    });


    // Update vehicles with realtime positions
    data.vehicles.forEach(vehicle => {
        let lat = vehicle.coordX;
        let lng = vehicle.coordY;
    
        const [boundedLat, boundedLng] = getPosition(lat, lng);
        const isOccupied = busyVehicleIds.has(vehicle.id);
        console.log(`Vehicle ${vehicle.id} bounded position:`, [boundedLat, boundedLng]);
    
        const markerId = `vehicle-${vehicle.id}`;
        if (!currentMarkers.has(markerId)) {
            const vehicleMarker = L.marker([boundedLat, boundedLng], {
                icon: L.divIcon({
                    html: `<div style="
                        background-color: ${isOccupied ? '#00BCD4' : '#4CAF50'};
                        width: 36px;
                        height: 36px;
                        border-radius: 50%;
                        display: flex;
                        align-items: center;
                        justify-content: center;
                        box-shadow: 0 0 20px rgba(0,0,0,0.2);
                    "><i class="fas fa-car-side"></i></div>`,
                    className: 'custom-marker'
                })
            }).addTo(map);
    
            vehicleMarker.bindPopup(`
                <div style="font-family: 'Inter', sans-serif; font-size: 12px;">
                    <strong style="color: #1a1a1a;">Vehicle ${vehicle.id}</strong><br>
                    <span style="color: ${isOccupied ? '#00BCD4' : '#4CAF50'};">
                        ${isOccupied ? 'On trip with customer' : 'Available'}
                    </span><br>
                    <span style="color: #4a5568;">
                        ${vehicle.numberOfTrips} trips · ${vehicle.distanceTravelled.toFixed(1)} km<br>
                        Position: [${lat.toFixed(6)}, ${lng.toFixed(6)}]
                    </span>
                </div>
            `);
    
            currentMarkers.set(markerId, vehicleMarker);
        } else {
            const marker = currentMarkers.get(markerId);
            marker.setLatLng([boundedLat, boundedLng]);
            
            // Update the icon when status changes
            marker.setIcon(L.divIcon({
                html: `<div style="
                    background-color: ${isOccupied ? '#00BCD4' : '#4CAF50'};
                    width: 36px;
                    height: 36px;
                    border-radius: 50%;
                    display: flex;
                    align-items: center;
                    justify-content: center;
                    box-shadow: 0 0 20px rgba(0,0,0,0.2);
                "><i class="fas fa-car-side"></i></div>`,
                className: 'custom-marker'
            }));
    
            // Update the popup content
            marker.getPopup().setContent(`
                <div style="font-family: 'Inter', sans-serif; font-size: 12px;">
                    <strong style="color: #1a1a1a;">Vehicle ${vehicle.id}</strong><br>
                    <span style="color: ${isOccupied ? '#00BCD4' : '#4CAF50'};">
                        ${isOccupied ? 'On trip with customer' : 'Available'}
                    </span><br>
                    <span style="color: #4a5568;">
                        ${vehicle.numberOfTrips} trips · ${vehicle.distanceTravelled.toFixed(1)} km<br>
                        Position: [${lat.toFixed(6)}, ${lng.toFixed(6)}]
                    </span>
                </div>
            `);
        }
        //TODO: ADD GREEN LINE FROM CAR TO CUSTOMER
    });
    
}


    
function updateStats(data) {
    if (!data) return;

    // Update connected units
    const totalVehicles = data.vehicles?.length || 0;
    const connectedUnitsElement = document.querySelector('.stats-overlay .stat-item:nth-child(2) .stat-value');
    if (connectedUnitsElement) {
        connectedUnitsElement.textContent = `${totalVehicles}/${totalVehicles}`;
    }

    // Update last update time
    updateLastUpdateTime();
}

function startUpdates() {
    console.log('Starting periodic updates');
    updateInterval = setInterval(async () => {
        console.log('Fetching update...');
        const state = await getScenarioState();
        if (state) {
            updateMap(state);
            updateStats(state);
        }
    }, 300);
}

function stopUpdates() {
    console.log('Stopping updates');
    if (updateInterval) {
        clearInterval(updateInterval);
        updateInterval = null;
    }
}

function updateUI(running) {
    const runButton = document.querySelector('.run-scenario');
    if (running) {
        runButton.innerHTML = `<i class="fas fa-stop"></i> Stop Scenario`;
        runButton.classList.add('running');
    } else {
        runButton.innerHTML = `<i class="fas fa-play"></i> Run Scenario`;
        runButton.classList.remove('running');
    }
}


// Add the legend
const legend = L.control({ position: 'bottomleft' });
legend.onAdd = function(map) {
    const div = L.DomUtil.create('div', 'legend');
    div.innerHTML = `
        <h4>Fleet Status</h4>
        <div class="legend-item">
            <i class="fas fa-user" style="color: #FFC107;"></i>
            <span>Waiting Customer</span>
        </div>
        <div class="legend-item">
            <i class="fas fa-car-side" style="color: #4CAF50;"></i>
            <span>Available Vehicle</span>
        </div>
        <div class="legend-item">
            <i class="fas fa-car-side" style="color: #00BCD4;"></i>
            <span>Vehicle with Customer</span>
        </div>
        <div class="legend-item">
            <i class="fas fa-flag" style="color: #FF5722;"></i>
            <span>Customer Destination</span>
        </div>
    `;
    return div;
};
legend.addTo(map);

// Add new functions for scenario handling
async function loadScenarios() {
    try {
        const response = await fetch('/scenarios');
        const scenarios = await response.json();
        
        const select = document.getElementById('scenarioSelect');
        select.innerHTML = '<option value="">Select a scenario...</option>';
        
        scenarios.forEach(scenario => {
            const option = document.createElement('option');
            option.value = scenario.id;
            option.textContent = `Scenario ${scenario.id}`;
            select.appendChild(option);
        });
    } catch (error) {
        console.error('Failed to load scenarios:', error);
    }
}

async function runScenario(scenarioId) {
    try {
        const response = await fetch(`/run/${scenarioId}`, {
            method: 'POST'
        });
        
        if (!response.ok) throw new Error('Failed to start scenario');
        
        simulationRunning = true;
        currentScenarioId = scenarioId;
        updateUI(true);
        startUpdates();
    } catch (error) {
        console.error('Error running scenario:', error);
    }
}

async function stopScenario() {
    try {
        if (!currentScenarioId) return;
        
        const response = await fetch(`/stop/${currentScenarioId}`, {
            method: 'POST'
        });
        
        if (!response.ok) throw new Error('Failed to stop scenario');
        
        simulationRunning = false;
        currentScenarioId = null;
        updateUI(false);
        stopUpdates();
    } catch (error) {
        console.error('Error stopping scenario:', error);
    }
}

async function getScenarioState() {
    try {
        if (!currentScenarioId) return null;
        
        const response = await fetch(`/scenario/${currentScenarioId}`);
        if (!response.ok) throw new Error('Failed to get scenario state');
        
        const data = await response.json();
        
        // Check if simulation has completed
        if (data.status === "COMPLETED") {
            showSimulationEndDialog();
        }
        
        lastUpdateTime = Date.now();
        return data;
    } catch (error) {
        console.error('Error getting scenario state:', error);
        return null;
    }
}

// Add event listeners
document.addEventListener('DOMContentLoaded', () => {
    loadScenarios();
    
    const runButton = document.querySelector('.run-scenario');
    runButton.addEventListener('click', async () => {
        if (simulationRunning) {
            await stopScenario();
        } else {
            const scenarioId = document.getElementById('scenarioSelect').value;
            if (!scenarioId) {
                alert('Please select a scenario first');
                return;
            }
            await runScenario(scenarioId);
        }
    });
});
</script>
{% endblock %}